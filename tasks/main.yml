# vim: tabstop=2 expandtab shiftwidth=2 softtabstop=2 smartindent
---
# - name: Download OPNsense XML sample config
#   get_url:
#     url: https://raw.githubusercontent.com/opnsense/core/master/src/etc/config.xml.sample
#     dest: /tmp/config.xml

- name: import DebOps secret role
  ansible.builtin.import_role:
    name: secret

- name: fetch
  tags:
    - always
  ansible.builtin.include_tasks:
    file: fetch.yml
    apply:
      tags:
        - fetch
        - always

- name: configd
  tags:
    - always
  ansible.builtin.include_tasks:
    file: configd.yml
    apply:
      tags:
        - configd

- name: template
  tags:
    - template
  ansible.builtin.template:
    src: '{{ opnsense_template }}'
    dest: '{{ local_config_path }}'
    validate: 'xmllint --noout %s'
  delegate_to: localhost
  when: opnsense_mode == 'xml_template'

- name: dnsserver
  tags:
    - always
  ansible.builtin.include_tasks:
    file: dnsserver.yml
    apply:
      tags:
        - dnsserver
        - dns
  when: opnsense_mode == 'xml_patch'

- name: dyndns
  tags:
    - always
  ansible.builtin.include_tasks:
    file: dyndns.yml
    apply:
      tags:
        - dyndns

- name: dnsmasq
  tags:
    - always
  ansible.builtin.include_tasks:
    file: dnsmasq.yml
    apply:
      tags:
        - dnsmasq

- name: user
  tags:
    - always
  ansible.builtin.include_tasks:
    file: user.yml
    apply:
      tags: user
  when: opnsense_mode == 'xml_patch'

- name: group
  tags:
    - always
  ansible.builtin.include_tasks:
    file: group.yml
    apply:
      tags: group
  when: opnsense_mode == 'xml_patch'

- name: general
  tags:
    - always
  ansible.builtin.include_tasks:
    file: general.yml
    apply:
      tags: general
  when: opnsense_mode == 'xml_patch'

- name: sysctl
  tags:
    - always
  ansible.builtin.include_tasks:
    file: sysctl.yml
    apply:
      tags: sysctl

- name: authservers
  tags:
    - always
  ansible.builtin.include_tasks:
    file: authservers.yml
    apply:
      tags: authservers
  when: opnsense_mode == 'xml_patch'

- name: CAs
  tags:
    - always
  ansible.builtin.include_tasks:
    file: ca.yml
    apply:
      tags:
        - ca
        - cert
        - certificates
  when: opnsense_mode == 'xml_patch'

- name: OpenVPN
  tags:
    - always
  ansible.builtin.include_tasks:
    file: openvpn.yml
    apply:
      tags:
        - openvpn
        - vpn
  when: opnsense_mode == 'xml_patch'

- name: IPSec
  tags:
    - always
  ansible.builtin.include_tasks:
    file: ipsec.yml
    apply:
      tags:
        - vpn
        - ipsec

- name: wireguard
  ansible.builtin.include_tasks:
    file: wireguard.yml
    apply:
      tags:
        - vpn
        - wg
        - wireguard
  tags:
    - always
  when: opnsense_mode == 'xml_patch'

- name: laggs
  tags:
    - always
  ansible.builtin.include_tasks:
    file: laggs.yml
    apply:
      tags:
        - laggs
        - lagg
  when: opnsense_mode == 'xml_patch'

- name: vlans
  tags:
    - always
  ansible.builtin.include_tasks:
    file: vlans.yml
    apply:
      tags:
        - vlans
        - vlan
  when: opnsense_mode == 'xml_patch' and opn_interfaces_vlan_parent_interface is defined

- name: interfaces
  tags:
    - always
  ansible.builtin.include_tasks:
    file: interfaces.yml
    apply:
      tags:
        - interfaces
        - interface
  when: opnsense_mode == 'xml_patch'

- name: bridges
  tags:
    - always
  ansible.builtin.include_tasks:
    file: bridges.yml
    apply:
      tags:
        - bridges
        - bridge
  when: opnsense_mode == 'xml_patch'

- name: virtualip
  tags:
    - always
  ansible.builtin.include_tasks:
    file: virtualip.yml
    apply:
      tags: virtualip
  when: opnsense_mode == 'xml_patch'

- name: alias
  tags:
    - always
  ansible.builtin.include_tasks:
    file: alias.yml
    apply:
      tags: alias
  when: opnsense_mode == 'xml_patch'

- name: filter
  tags:
    - always
  ansible.builtin.include_tasks:
    file: filter.yml
    apply:
      tags: filter
  when: opnsense_mode == 'xml_patch'

- name: gateways
  tags:
    - always
  ansible.builtin.include_tasks:
    file: gateways.yml
    apply:
      tags:
        - gateways
        - gateway
  when: opnsense_mode == 'xml_patch'

- name: hasync
  tags:
    - always
  ansible.builtin.include_tasks:
    file: hasync.yml
    apply:
      tags: hasync
  when: opnsense_mode == 'xml_patch'

- name: dhcpd
  tags:
    - always
  ansible.builtin.include_tasks:
    file: dhcpd.yml
    apply:
      tags:
        - dhcpd
        - dhcp
  when: opnsense_mode == 'xml_patch'

- name: unbound
  tags:
    - always
  ansible.builtin.include_tasks:
    file: unbound.yml
    apply:
      tags: unbound
  when: opnsense_mode == 'xml_patch'

- name: syslog
  tags:
    - always
  ansible.builtin.include_tasks:
    file: syslog.yml
    apply:
      tags: syslog
  when: opnsense_mode == 'xml_patch'

- name: monit
  tags:
    - always
  ansible.builtin.include_tasks:
    file: monit.yml
    apply:
      tags: monit
  when: opnsense_mode == 'xml_patch'

- name: staticroutes
  tags:
    - always
  ansible.builtin.include_tasks:
    file: staticroutes.yml
    apply:
      tags:
        - staticroutes
        - routing
        - routes
        - route
  when: opnsense_mode == 'xml_patch'

- name: nat
  tags:
    - always
  ansible.builtin.include_tasks:
    file: nat.yml
    apply:
      tags: nat
  when: opnsense_mode == 'xml_patch'

- name: haproxy
  tags:
    - always
  ansible.builtin.include_tasks:
    file: haproxy.yml
    apply:
      tags: haproxy
  when: opnsense_mode == 'xml_patch'

- name: cron
  tags:
    - always
  ansible.builtin.include_tasks:
    file: cron.yml
    apply:
      tags: cron

- name: trim EOF
  delegate_to: localhost
  ansible.builtin.lineinfile:
    state: absent
    insertafter: EOF
    line: ""
    path: "{{ local_config_path }}"
  changed_when: false
  when: opnsense_mode == 'xml_patch'
  tags: trim

- name: fix xml start tag
  delegate_to: localhost
  ansible.builtin.lineinfile:
    line: '<?xml version="1.0"?>'
    regexp: '^<\?xml.*>'
    insertbefore: BOF
    path: "{{ local_config_path }}"
  changed_when: false
  when: opnsense_mode == 'xml_patch'
  tags: trim

- name: copy
  ansible.builtin.copy:
    src: "{{ local_config_path }}"
    dest: "{{ config_path }}"
    backup: true
    owner: root
    group: wheel
    mode: "0644"
  register: config
  notify:
    - 'restart webgui'
    - 'sync filter'
    - 'reload all services'
    - 'restart WireGuard'
    - 'restart snmpd'
  tags: copy

- name: clean,safe delete  # noqa no-changed-when
  delegate_to: localhost
  ansible.builtin.command: srm "{{ local_config_path }}"
  tags: clean
  when: delete_local_xml_file | default(false)

- name: create handler helper scripts
  ansible.builtin.template:
    src: "{{ item }}.j2"
    dest: "/usr/local/sbin/{{ item }}"
    owner: root
    group: wheel
    mode: "0750"
  tags: copy
  with_items:
    - opnsense_service_mimic.php
    - opnsense_synclocalaccounts.php
  when:
    - config is defined
    - config.changed | bool

- name: sync  # noqa no-handler no-changed-when
  ansible.builtin.command: "{{ item }}"
  throttle: 1
  # loop_control:
  #   pause: 3
  with_items:
    - configctl filter sync
  when: config.changed
  tags:
    - sync
    - copy

- name: reload  # noqa no-handler no-changed-when
  ansible.builtin.command: "{{ item }}"
  throttle: 1
  # loop_control:
  #   pause: 3
  with_items:
    - configctl service reload all
    - configctl webgui restart
  when: config.changed

- name: reload wireguard
  ansible.builtin.command: "{{ item.command }}"
  when: (item.when|bool)
  with_items:
    - command: configctl wireguard restart
      when: '{{ config is changed and
                lookup("xmlfile", local_config_path_fetch, xpath="opnsense/OPNsense/wireguard") !=
                lookup("xmlfile", local_config_path, xpath="opnsense/OPNsense/wireguard") }}'

  # Reload services last as that might kill the ssh connection.
- name: Execute pending handlers
  ansible.builtin.meta: 'flush_handlers'

- name: copy
  ansible.builtin.copy:
    src: "{{ local_config_path }}"
    dest: "{{ local_config_path_fetch }}"
  register: config
  delegate_to: localhost
  tags: copy
...
