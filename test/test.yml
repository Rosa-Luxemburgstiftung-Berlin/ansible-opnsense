---

- name: run test
  hosts: testhosts
  vars:
    #ansible_python_interpreter: "/usr/bin/env python"  # REQUIRED for github action
    config_path: test/{{ inventory_hostname }}.xml
    local_config_path: cfg/{{ inventory_hostname }}.xml
    all_tests: {}
  handlers:
    - name: reconfigure aliases
      debug:
        msg: fake handler - reconfigure aliases
    - name: restart openvpn
      debug:
        msg: fake handler - restart openvpn
    - name: reconfigure wireguard
      debug:
        msg: fake handler - reconfigure wireguard
    - name: configure routing
      debug:
        msg: fake handler - configure routing
    - name: restart ipsec
      debug:
        msg: fake handler - restart ipsec
    - name: stop ipsec  # TODO: test this action; use community.general.xml and add a tag to the resulting xml
      debug:
        msg: fake handler - stop ipsec
    - name: restart dyndns
      debug:
        msg: fake handler - restart dyndns

  tasks:
    - name: include default vars
      ansible.builtin.include_vars:
        file: ../defaults/main.yml
    - name: "simple task test {{ _testtask }} ..."
      ansible.builtin.include_tasks: testsimpletask.yml
      loop_control:
        label: "{{ _testtask }}"
        loop_var: _testtask
      with_items:
        - general
        - filter
        - alias
        - gateways
        - wireguard
        - ipsec
        - dnsserver
        - openvpn
        - dyndns
      when:
        - test | default(_testtask) == _testtask
    - ansible.builtin.meta: flush_handlers
    - name: report all tests
      ansible.builtin.debug:
        var: all_tests
