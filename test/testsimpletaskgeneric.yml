---

- name: register test in all_tests
  ansible.builtin.set_fact:
    all_tests: "{{ all_tests | combine({_testtask: all_tests[_testtask] + [_test]}) }}"

- name: "copy test file {{ _test }}"
  ansible.builtin.copy:
    src: "{{ lookup('ansible.builtin.first_found', testxmlfile) }}"
    dest: "cfg/{{ _test }}.xml"
    remote_src: true
  vars:
    testxmlfile:
      files:
        - "{{ _test }}.xml"
        - 00default.xml
- name: "read test vars for {{ _test }}"
  ansible.builtin.include_vars:
    file: "{{ _test }}.yml"
- name: "set local cfg path to 'cfg/{{ _test }}.xml'"
  ansible.builtin.set_fact:
    local_config_path: "cfg/{{ _test }}.xml"
- name: "import {{ _testtask }} task for {{ _test }}"
  ansible.builtin.include_tasks:
    file: "../tasks/{{ _testtask }}.yml"
- name: "detect diff between result and expected state for {{ _test }}"
  ansible.builtin.command: "cmp -s '{{ local_config_path }}' '{{ _test }}-expect.xml'"
  register: cmp
  failed_when: cmp.rc > 0
- name: "finished test {{ _testtask }} {{ _test }}"
  ansible.builtin.debug:
    msg: "test {{ _testtask }} {{ _test }} : OK"
