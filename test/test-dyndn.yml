---
- name: Update DynDNS Configuration XML
  hosts: localhost
  vars:
    opn_dyndns_general:
      - key: enabled
        value: "1"
      - key: verbose
        value: "0"
      - key: allowipv6
        value: "0"
      - key: daemon_delay
        value: "300"
      - key: backend
        value: "opnsense"
    opn_dyndns_accounts:
      - uuid: "8e4627c4-21ff-4252-a331-3d1adee0a023"
        settings:
          - key: enabled
            value: "1"
          - key: service
            value: "noip"
          - key: protocol
            value: ""
          - key: server
            value: ""
          - key: username
            value: ""
          - key: password
            value: ""
          - key: resourceId
            value: ""
          - key: hostnames
            value: "all.ddnskey.com"
          - key: wildcard
            value: "0"
          - key: zone
            value: ""
          - key: checkip
            value: "web_noip-ipv4"
          - key: checkip_timeout
            value: "10"
          - key: force_ssl
            value: "1"
          - key: ttl
            value: "300"
          - key: interface
            value: "wan"
          - key: description
            value: "" 
  tasks:
    - name: Update general DynDNS settings
      community.general.xml:
        path: "{{ playbook_dir }}/dyndns-test-expected.xml"
        xpath: "/opnsense/OPNSense/DynDNS/general/{{ item.key }}"
        value: "{{ item.value }}"
        state: present
        pretty_print: true
      loop: "{{ opn_dyndns_general }}"
      delegate_to: localhost

    - name: Update account specific DynDNS settings
      community.general.xml:
        path: "{{ playbook_dir }}/dyndns-test-expected.xml"
        xpath: "/opnsense/OPNSense/DynDNS/accounts/account[@uuid='{{ item.0.uuid }}']/{{ item.1.key }}"
        value: "{{ item.1.value }}"
        state: present
        pretty_print: true
      with_subelements:
        - "{{ opn_dyndns_accounts }}"
        - settings
      delegate_to: localhost
